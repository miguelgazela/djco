<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>Space Invaders</title>

        <style>
            html,
            body {
                height: 100%;
                background-color: #030405;
                margin: 0;
            }

            canvas {
                margin: 0 auto;
                border-left: 2px solid #010101;
                border-right: 2px solid #010101;
            }
ยง
        </style>
    </head>
    <body>

    <script src="js/phaser.min.js"></script>
    <script src="https://code.jquery.com/jquery-1.10.2.min.js"></script>

    <script src="js/game_variables.js"></script>

    <script type="text/javascript">

    window.onload = function() {

        var game = new Phaser.Game(CANVAS_WIDTH, CANVAS_HEIGHT, Phaser.AUTO, 'Space Invaders', { preload: preload, create: create, update: update, render: render });

        function preload () {

            loadImage(IMAGE_STARFIELD);
            loadImage(IMAGE_SHIP);
            loadImage(IMAGE_LOGO);
            loadImage(IMAGE_P1_BULLET);
            loadImage(IMAGE_MINE);
            loadImage(IMAGE_SMALL_METEOR);
            loadImage(IMAGE_POWERUP);

            game.load.spritesheet('invader', 'assets/invader32x32x4.png', 32, 32);
            game.load.spritesheet('explosion', 'assets/explode.png', 128, 128);
            game.load.spritesheet(IMAGE_BTN_PLAY, 'assets/' + IMAGE_BTN_PLAY + '.png', 170, 76);
            game.load.spritesheet(IMAGE_BTN_PLAY_AGAIN, 'assets/' + IMAGE_BTN_PLAY_AGAIN + '.png', 170, 76);

            game.load.audio('s_laser', 'assets/audio/laser.wav');
            game.load.audio('s_explosion', 'assets/audio/explode.wav');

        }

        function create () {

            game.physics.startSystem(Phaser.Physics.ARCADE);

            //  The scrolling starfield background
            starfield = game.add.tileSprite(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT, 'starfield');

            // Menu HUD
            hudImgLogo = game.add.sprite(0, 40, IMAGE_LOGO);
            hudImgLogo.x = game.world.centerX - hudImgLogo.width / 2;
            hudBtnPlay = game.add.button(0, 300, IMAGE_BTN_PLAY, onBtnPlay, this, 1, 0, 1);
            hudBtnPlay.x = game.world.width / 2 - hudBtnPlay.width / 2;

            //  The hero!
            player = game.add.sprite(CANVAS_WIDTH/2, CANVAS_HEIGHT - 320, 'ship');
            game.physics.enable(player, Phaser.Physics.ARCADE);
            player.anchor.setTo(0.5, 0.5);
            player.health = 100;

            //  Our bullet group
            bullets = game.add.group();
            bullets.enableBody = true;
            bullets.physicsBodyType = Phaser.Physics.ARCADE;
            bullets.createMultiple(30, IMAGE_P1_BULLET);
            bullets.setAll('checkWorldBounds', true);
            bullets.setAll('outOfBoundsKill', true);
            bullets.setAll('anchor.x', 0.5);
            bullets.setAll('anchor.y', 1);

            //  The enemy's bullets
            enemyBullets = game.add.group();
            enemyBullets.enableBody = true;
            enemyBullets.physicsBodyType = Phaser.Physics.ARCADE;
            enemyBullets.createMultiple(30, 'enemyBullet');
            enemyBullets.setAll('anchor.x', 0.5);
            enemyBullets.setAll('anchor.y', 1);
            enemyBullets.setAll('checkWorldBounds', true);
            enemyBullets.setAll('outOfBoundsKill', true);

            //  Our mines group
            mines = game.add.group();
            mines.createMultiple(30, 'mine');
            mines.setAll('anchor.x', 0.5);
            mines.setAll('anchor.y', 1);
            mines.setAll('outOfBoundsKill', true);

            //  group of meteors
            meteors = game.add.group();
            meteors.enableBody = true;
            meteors.physicsBodyType = Phaser.Physics.ARCADE;
            meteors.createMultiple(30, IMAGE_SMALL_METEOR);
            meteors.setAll('anchor.x', 0.5);
            meteors.setAll('anchor.y', 1);
            meteors.setAll('checkWorldBounds', true);
            meteors.setAll('outOfBoundsKill', true);
            meteors.setAll('body.bounce.x', 1);
            meteors.setAll('body.bounce.y', 1);
            meteors.setAll('body.minBounceVelocity', 0);

            //  The enemies
            aliens = game.add.group();
            aliens.enableBody = true;
            aliens.physicsBodyType = Phaser.Physics.ARCADE;
            createAliens();

            // power ups pool
            powerups = game.add.group();
            powerups.enableBody = true;
            powerups.physicsBodyType = Phaser.Physics.ARCADE;
            powerups.createMultiple(10, IMAGE_POWERUP);
            powerups.setAll('anchor.x', 0.5);
            powerups.setAll('anchor.y', 0.5);
            powerups.setAll('checkWorldBounds', true);
            powerups.setAll('outOfBoundsKill', true);
            powerups.setAll('power', "MINE");

            //  Explosion pool
            explosions = game.add.group();
            explosions.createMultiple(10, 'explosion');
            explosions.forEach(setupInvader, this);

            //  Controls to play the game
            cursors = game.input.keyboard.createCursorKeys();
            fireButton = game.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR);
            dropButton = game.input.keyboard.addKey(Phaser.Keyboard.SHIFT);

            //  Game Hud
            style = { fontSize: '26px', fill: '#e9e9e9' };
            hudTxtScore = game.add.text(10, 10, "Score: " + score, style);
            hudTxtScore.visible = false;

            hudTxtHealth = game.add.text(800, 10, "Health: " + player.health, style);
            hudTxtHealth.visible = false;

            healthBar = new Phaser.Rectangle(HEALTH_BAR_X, HEALTH_BAR_Y, 144, 10);
            gunHeatBackgroundBar = new Phaser.Rectangle(GUN_HEAT_BAR_BG_X, GUN_HEAT_BAR_BG_Y, 102, 10);
            gunHeatBar = new Phaser.Rectangle(GUN_HEAT_BAR_X, GUN_HEAT_BAR_Y, 6, 6);

            // sounds
            s_laser = game.add.audio('s_laser');
            s_explosion = game.add.audio('s_explosion');

            gameState = GAMESTATE_NOTSTARTED;

        }

        function update () {

            

            if (gameState == GAMESTATE_PLAYING) {

                //  Scroll the background
                starfield.tilePosition.y += backgroundScrollSpeed;
                backgroundScrollSpeed += speedInc;

                processInput();

                // decrease gun heat
                gunHeat = Math.max(6, gunHeat - 0.4);
                updateHeatBar();

                // if (game.time.now > firingTimer) {
                //     enemyFires();
                // }

                if (game.time.now > meteorTimer) {
                    sendMeteor();
                }

                // //  Check collisions
                // game.physics.overlap(mines, aliens, playerHitsEnemies, null, this);
                game.physics.arcade.overlap(enemyBullets, player, enemyHitsPlayer, null, this);
                game.physics.arcade.overlap(meteors, player, meteorHitsPlayer, null, this);
                game.physics.arcade.overlap(bullets, meteors, bulletHitsMeteor, null, this);
                // game.physics.overlap(enemyBullets, meteors, bulletHitsMeteor, null, this);

                game.physics.arcade.collide(meteors);
            }

        }

        function processInput() {

            //  Reset the player, then check the movement keys
            player.body.velocity.setTo(0, 0);

            if (cursors.left.isDown) {
                player.body.velocity.x = -200;
                if (cursors.up.isDown) {
                    player.body.velocity.y = -200;
                } else if (cursors.down.isDown) {
                    if (player.y < BOTTOM_LIMIT) {
                        player.body.velocity.y = 200;
                    }
                }
            } else if (cursors.right.isDown) {
                player.body.velocity.x = 200;
                if (cursors.up.isDown) {
                    player.body.velocity.y = -200;
                } else if (cursors.down.isDown) {
                    if (player.y < BOTTOM_LIMIT) {
                        player.body.velocity.y = 200;
                    }
                }
            } else if (cursors.up.isDown) {
                player.body.velocity.y = -200;
            } else if (cursors.down.isDown) {
                if (player.y < BOTTOM_LIMIT) {
                    player.body.velocity.y = 200;
                }
            }

            //  Check if hero has moved to the other side
            if ((player.body.x + (PLAYER_SHIP_WIDTH / 2) - 2) < 0) {
                player.body.x = CANVAS_WIDTH + (PLAYER_SHIP_WIDTH / 2) - 2;  //  -2 just to see the tip of the wing
            }  
            else if ((player.body.x - (PLAYER_SHIP_WIDTH / 2) + 2) > CANVAS_WIDTH) {
                player.body.x = 0 - (PLAYER_SHIP_WIDTH / 2) + 2;  //  + 2 just to see the tip of the wing
            }

            // //  Check if it's dropping a mine
            // if (dropButton.isDown) {
            //     dropMine();
            // }

            aliens.setAll('body.velocity.x', 0);
            var atTheEdge = false;
            var velocity = 0;

            if (game.input.keyboard.isDown(Phaser.Keyboard.A)) {
                aliens.forEachAlive(function(child, index) {
                    if (child.body.x - 16 < 1) {
                        atTheEdge = true;
                    }
                });
                velocity = -200;
                
            } else if (game.input.keyboard.isDown(Phaser.Keyboard.D)) {
                aliens.forEachAlive(function(child, index) {
                    if (child.body.x + 16 > CANVAS_HEIGHT - 1) {
                        atTheEdge = true;
                    }
                });
                velocity = -200;
            }

            if(!atTheEdge) {
                aliens.setAll('body.velocity.x', velocity);
            }

            // Check if is firing
            if (fireButton.isDown) {
                fireBullet();
            }

        }

        function render () {

            if (gameState == GAMESTATE_PLAYING) {
                var healthBarColor = "#2ecc71";
                if (player.health < 30) {
                    healthBarColor = "#c0392b";
                } else if (player.health < 75) {
                    healthBarColor = "#f1c40f";
                }

                game.debug.geom(healthBar, healthBarColor);

                var gunHeatBarColor = "#2ecc71";
                if ( gunHeat > 80 ) {
                    gunHeatBarColor = "#c0392b";
                } else if ( gunHeat > 40 ) {
                    gunHeatBarColor = "#f1c40f";
                }
                game.debug.geom(gunHeatBackgroundBar, "#ddd");
                game.debug.geom(gunHeatBar, gunHeatBarColor);

                // game.debug.bodyInfo(player, 32, 320);
                // game.debug.spriteBounds(player);
                meteors.children.forEach(function(child, index) {
                    if (index < 2) {
                        game.debug.spriteBounds(child);
                    }
                });
            }
            

        }

        // ------------------------------------------------------------------------------------------------
        // ------------------------------------------------------------------------------------------------
        //  
        //                                          Custom functions
        // 
        // ------------------------------------------------------------------------------------------------
        // ------------------------------------------------------------------------------------------------

        function enemyFires () {

            enemyBullet = enemyBullets.getFirstExists(false);
            livingEnemies.length = 0;

            aliens.forEachAlive(function (alien) {
                livingEnemies.push(alien);
            });

            if (enemyBullet && livingEnemies.length > 0) {
                var random = game.rnd.integerInRange(0, livingEnemies.length - 1);

                var shooter = livingEnemies[random];
                console.log(shooter.body.x);
                console.log(shooter.body.y);
                enemyBullet.reset(shooter.body.x, shooter.body.y);

                game.physics.arcade.moveToObject(enemyBullet, player, 120);
                firingTimer = game.time.now + 2000;
            }
        }

        function sendMeteor () {

            var randomX = game.rnd.integerInRange(0, CANVAS_WIDTH);
            meteor = meteors.getFirstExists(false);

            if (meteor) {
                meteor.reset(randomX, -21);
                meteor.body.velocity.y = game.rnd.integerInRange(50, 200);
                meteor.body.velocity.x = game.rnd.integerInRange(-50, 50);
                // meteor.body.angularVelocity = 10;
                // meteor.body.rotation = game.rnd.integerInRange(1, 20);
                meteorTimer = game.time.now + 400;
            }

        }

        function bulletHitsMeteor (bullet, meteor) {

            bullet.kill();
            meteor.kill();
            createExplosion(bullet.body.x, bullet.body.y - 36);

            dropPowerUp(meteor.body.x, meteor.body.y);

            // update player score
            score += 5;
            hudTxtScore.text = "Score: " + score;

        }

        function dropPowerUp(x, y) {

            random = game.rnd.frac();

            if (random > 0.8) { // 20% probability of dropping powerup
                powerup = powerups.getFirstExists(false);

                if (powerup) {
                    powerup.reset(x, y);
                    powerup.body.velocity.y = 150;
                }
            }

        }

        function meteorHitsPlayer (player, meteor) {

            meteor.kill();
            createExplosion(player.body.x, player.body.y);

            // decrease player's health
            damagePlayer(10);
        }

        function damagePlayer(damage) {
            player.damage(damage);
            hudTxtHealth.text = "Health: " + player.health;
            updateHealthBar();
            checkGameOver();
        }

        function playerHitsEnemies (mine, alien) {

            mine.kill();
            alien.kill();
            createExplosion(alien.body.x, alien.body.y);

            //  Increase the score
            score += 20;
            hudTxtScore.content = "Score: " + score;

        }

        function enemyHitsPlayer (player, bullet) {

            bullet.kill();
            createExplosion(player.body.x, player.body.y);

            // decrease player's health
            damagePlayer(20);
        }

        function setupInvader (invader) {

            invader.anchor.x = 0.5;
            invader.anchor.y = 0.5;
            invader.animations.add('explosion');

        }

        function createAliens () {

            var NUM_COL = 6;
            var DIST_BETWEEN = 140;

            for (var y = 0; y < 4; y++) {
                for (var x = 0; x < NUM_COL; x++) {
                    var alien = aliens.create(x * DIST_BETWEEN, y * 50, 'invader');
                    alien.anchor.setTo(0.5, 0.5);
                    // alien.animations.add('fly', [0, 1, 2, 3], 20, true);
                    // alien.play('fly');
                }
            }

            aliens.x = (CANVAS_WIDTH - (NUM_COL * 32 + (NUM_COL - 1) * (DIST_BETWEEN - 32))) / 2 + 16;
            aliens.y = CANVAS_HEIGHT - 200;

            // var tween = game.add.tween(aliens).to( {x: 130}, 1000, Phaser.Easing.Linear.None, true, 0, 1000, true);
            // tween.onComplete.add(function () { aliens.y += 10; }, this);

        }

        function fireBullet () {

            //  To avoid them being allowed to fire too fast we set a time limit
            if (game.time.now > bulletTime && game.time.now > gunCooldown) {
                //  Grab the first bullet we can from the pool
                bullet = bullets.getFirstExists(false);

                if (bullet) {

                    //  And fire it
                    bullet.reset(player.x, player.y + 8);
                    bullet.body.velocity.y = -400;
                    bulletTime = game.time.now + 200;
                    // s_laser.play();

                    // add heat to gun
                    gunHeat = Math.min(gunHeat + 15, 100);
                    updateHeatBar();
                    if (gunHeat === 100) {
                        gunCooldown = game.time.now + 3000; // if weapons gets too hot, needs to wait 3 seconds
                    }
                }
            }

        }

        function updateHeatBar () {
            gunHeatBar.setTo(GUN_HEAT_BAR_X, GUN_HEAT_BAR_Y, gunHeat, 6);
        }

        function updateHealthBar () {
            healthBar.setTo(HEALTH_BAR_X, HEALTH_BAR_Y, healthBar.width - 14.4, healthBar.height);
        }

        function dropMine () {

            if (game.time.now > mineTime) {
                mine = mines.getFirstExists(false);

                if (mine) {
                    mine.reset(player.x, player.y + 12);
                    mine.body.velocity.y = 100;
                    mineTime = game.time.now + 400;
                }
            }

        }

        function createExplosion(x, y) {

            // create an explosion
            // s_explosion.play();
            var explosion = explosions.getFirstDead();
            explosion.reset(x, y);
            explosion.play('explosion', 30, false, true);

        }

        function onBtnPlay() {

            hudBtnPlay.visible = false;
            hudBtnPlay.active = false;
            hudTxtScore.visible = true;
            hudTxtHealth.visible = true;

            if (playedOnce) {
                hudImgLogo.visible = false;
            } else {
                var tween = game.add.tween(hudImgLogo).to({alpha: 0}, 200, Phaser.Easing.Linear.None, true, 0, 0, false);
                tween.onComplete.add(function() {
                    hudImgLogo.visible = false;
                });
            }

            gameState = GAMESTATE_PLAYING;

        }

        function loadImage(image) {
            game.load.image(image, 'assets/' + image + '.png');
        }

        function checkGameOver() {



        }

    };

    </script>

    </body>
</html>