<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>Space Invaders</title>
        <script src="js/phaser.min.js"></script>

        <style>
            body {
                background-color: black;
            }

            canvas {
                margin: 0 auto;
            }
        </style>
    </head>
    <body>

    <script type="text/javascript">

    window.onload = function() {

        var game = new Phaser.Game(600, 900, Phaser.AUTO, 'Space Invaders', { preload: preload, create: create, update: update });

        var player;
        var aliens;
        var bullets;
        var bulletTime = 0;
        var cursors;
        var fireButton;
        var starfield;
        var enemyBullet;
        var livingEnemies = [];
        var backgroundScrollSpeed = 2;
        var speedInc = 0.0005;

        function preload () {

            game.load.image('starfield', 'assets/starfield.png');
            game.load.image('ship', 'assets/player.png');
            game.load.image('bullet', 'assets/bullet.png');
            game.load.spritesheet('invader', 'assets/invader32x32x4.png', 32, 32);

        }

        function create () {

            //  The scrolling starfield background
            starfield = game.add.tileSprite(0, 0, 600, 900, 'starfield');

            //  The hero!
            player = game.add.sprite(300, 500, 'ship');
            player.anchor.setTo(0.5, 0.5);

            //  Our bullet group
            bullets = game.add.group();
            bullets.createMultiple(100, 'bullet');
            bullets.setAll('anchor.x', 0.5);
            bullets.setAll('anchor.y', 1);

            //  The enemies
            aliens = game.add.group();
            createAliens();

            //  Controls to play the game
            cursors = game.input.keyboard.createCursorKeys();
            fireButton = game.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR);

        }

        function update () {

            //  Scroll the background
            backgroundScrollSpeed += speedInc;
            starfield.tilePosition.y += backgroundScrollSpeed;

            //  Reset the player, then check the movement keys
            player.body.velocity.setTo(0, 0);

            if (cursors.left.isDown) {
                player.body.velocity.x = -200;
                if (cursors.up.isDown) {
                    player.body.velocity.y = -200;
                } else if (cursors.down.isDown) {
                    player.body.velocity.y = 200;
                }
            } else if (cursors.right.isDown) {
                player.body.velocity.x = 200;
                if (cursors.up.isDown) {
                    player.body.velocity.y = -200;
                } else if (cursors.down.isDown) {
                    player.body.velocity.y = 200;
                }
            } else if (cursors.up.isDown) {
                player.body.velocity.y = -200;
            } else if (cursors.down.isDown) {
                if (player.y < 640) {
                    player.body.velocity.y = 200;
                }
            }

            // Check if is firing
            if (fireButton.isDown) {
                fireBullet();
            }

            //  Check if hero has moved to the other side
            //  TODO needs to be improved
            if (player.x < 0) {
                player.x = 600;
            } else if (player.x > 600) {
                player.x = 0;
            }
        }

        //  Custom functions

        function createAliens () {
            for (var y = 0; y < 4; y++) {
                for (var x = 0; x < 10; x++) {
                    var alien = aliens.create(x * 48, y * 50, 'invader');
                    alien.anchor.setTo(0.5, 0.5);
                    alien.animations.add('fly', [0, 1, 2, 3], 20, true);
                    alien.play('fly');
                }
            }

            aliens.x = 40;
            aliens.y = 700;

            var tween = game.add.tween(aliens).to( {x: 120}, 1000, Phaser.Easing.Linear.None, true, 0, 1000, true);
            tween.onComplete.add(function () { aliens.y += 10; }, this);
        }

        function fireBullet () {

            //  To avoid them being allowed to fire too fast we set a time limit
            if (game.time.now > bulletTime) {
                //  Grab the first bullet we can from the pool
                bullet = bullets.getFirstExists(false);

                if (bullet) {
                    //  And fire it
                    bullet.reset(player.x, player.y + 8);
                    bullet.body.velocity.y = -400;
                    bulletTime = game.time.now + 200;
                }
            }

        }

    };

    </script>

    </body>
</html>